name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # Lint and type-check frontend
  frontend-lint:
    name: Frontend Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type check
        run: npm run type-check

  # Lint and test backend
  backend-lint:
    name: Backend Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Ruff linter
        run: ruff check src/

      - name: Run Ruff formatter check
        run: ruff format --check src/

      - name: Run tests
        run: pytest tests/ -v --tb=short
        env:
          DATABASE_URL: sqlite:///./test.db
          ENVIRONMENT: test
        continue-on-error: true # Allow tests to fail if not set up yet

  # Build frontend
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: frontend-lint
    defaults:
      run:
        working-directory: apps/web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ''

  # Build backend Docker image
  backend-build:
    name: Backend Docker Build
    runs-on: ubuntu-latest
    needs: backend-lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          push: false
          tags: explain-my-game-api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Integration tests with Docker Compose
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_USER=emg_user
          POSTGRES_PASSWORD=emg_password
          POSTGRES_DB=explain_my_game
          DATABASE_URL=postgresql://emg_user:emg_password@postgres:5432/explain_my_game
          ENVIRONMENT=development
          SEED_DATABASE=true
          OPENAI_API_KEY=sk-test-placeholder-for-ci
          EOF

      - name: Start services
        run: docker compose up -d --build

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for API to be healthy..."
          timeout 120 bash -c 'until curl -s http://localhost:8000/health | grep -q "healthy"; do sleep 5; done'
          echo "API is healthy!"

      - name: Run health check
        run: |
          curl -f http://localhost:8000/health
          echo ""
          curl -f http://localhost:3000 || echo "Frontend check (may fail in CI)"

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose logs api
          docker compose logs web
          docker compose logs postgres

      - name: Shutdown services
        if: always()
        run: docker compose down -v

  # Deploy to staging
  # Triggers on push to develop branch
  # NOTE: Requires these secrets to be configured in GitHub:
  # - FLY_API_TOKEN: Fly.io API token
  # - FLY_APP_NAME_STAGING: Name of your staging Fly.io app
  # - VERCEL_TOKEN: Vercel API token
  # - VERCEL_ORG_ID: Vercel organization ID
  # - VERCEL_PROJECT_ID: Vercel project ID
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    concurrency:
      group: staging-deploy
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Validate required secrets are configured
      - name: Validate deployment secrets
        run: |
          missing_secrets=""
          if [ -z "${{ secrets.FLY_API_TOKEN }}" ]; then
            missing_secrets="$missing_secrets FLY_API_TOKEN"
          fi
          if [ -z "${{ secrets.FLY_APP_NAME_STAGING }}" ]; then
            missing_secrets="$missing_secrets FLY_APP_NAME_STAGING"
          fi
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            missing_secrets="$missing_secrets VERCEL_TOKEN"
          fi
          
          if [ -n "$missing_secrets" ]; then
            echo "❌ Missing required secrets:$missing_secrets"
            echo ""
            echo "Please configure the following secrets in GitHub:"
            echo "  Settings > Secrets and variables > Actions > New repository secret"
            echo ""
            echo "See DEPLOYMENT.md for setup instructions."
            exit 1
          fi
          echo "✅ All required secrets are configured"

      # Deploy Backend to Fly.io (Staging)
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy API to Fly.io Staging
        working-directory: apps/api
        run: |
          flyctl deploy --remote-only --app ${{ secrets.FLY_APP_NAME_STAGING }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # Deploy Frontend to Vercel (Staging/Preview)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy Frontend to Vercel (Preview)
        working-directory: apps/web
        run: |
          vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # Deploy to production
  # Triggers on push to main branch
  # NOTE: Requires these secrets to be configured in GitHub:
  # - FLY_API_TOKEN: Fly.io API token
  # - FLY_APP_NAME_PRODUCTION: Name of your Fly.io app (e.g., explain-my-game-api)
  # - VERCEL_TOKEN: Vercel API token
  # - VERCEL_ORG_ID: Vercel organization ID
  # - VERCEL_PROJECT_ID: Vercel project ID
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.ref == 'refs/heads/main'
    environment: production
    concurrency:
      group: production-deploy
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Validate required secrets are configured
      - name: Validate deployment secrets
        run: |
          missing_secrets=""
          if [ -z "${{ secrets.FLY_API_TOKEN }}" ]; then
            missing_secrets="$missing_secrets FLY_API_TOKEN"
          fi
          if [ -z "${{ secrets.FLY_APP_NAME_PRODUCTION }}" ]; then
            missing_secrets="$missing_secrets FLY_APP_NAME_PRODUCTION"
          fi
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            missing_secrets="$missing_secrets VERCEL_TOKEN"
          fi
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            missing_secrets="$missing_secrets VERCEL_ORG_ID"
          fi
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            missing_secrets="$missing_secrets VERCEL_PROJECT_ID"
          fi
          
          if [ -n "$missing_secrets" ]; then
            echo "❌ Missing required secrets:$missing_secrets"
            echo ""
            echo "Please configure the following secrets in GitHub:"
            echo "  Settings > Secrets and variables > Actions > New repository secret"
            echo ""
            echo "See DEPLOYMENT.md for setup instructions."
            exit 1
          fi
          echo "✅ All required secrets are configured"

      # Deploy Backend to Fly.io (Production)
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy API to Fly.io Production
        working-directory: apps/api
        run: |
          flyctl deploy --remote-only --app ${{ secrets.FLY_APP_NAME_PRODUCTION }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      # Deploy Frontend to Vercel (Production)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy Frontend to Vercel (Production)
        working-directory: apps/web
        run: |
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Notify Deployment Success
        run: |
          echo "✅ Production deployment complete!"
          echo "Frontend: https://your-domain.vercel.app"
          echo "Backend: https://${{ secrets.FLY_APP_NAME_PRODUCTION }}.fly.dev"

